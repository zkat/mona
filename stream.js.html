<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: stream.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: stream.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>"use strict";

var Transform = require("stream").Transform,
    util = require("util"),
    mona = require("./mona");
util.inherits(StreamParser, Transform);

/**
 * Implements node.js' transformer stream API. That is, it implements the
 * [transform](http://nodejs.org/api/stream.html#stream_class_stream_transform)
 * stream interface.
 *
 * By default, `parseStream` is a passthrough stream for incoming data, and a
 * "parsed" event is emitted on the results of successful parses. If your parser
 * returns string/binary chunks, you can use the `transformOutput` option to
 * make `parseStream`'s output be the parser's "data" output instead of just the
 * incoming data.
 *
 * For now, `parseStream` only supports utf8 streams.
 *
 * @param {Function} parser - The parser to execute.
 * @param {Object} [opts] - Options object.
 * @param {Boolean} [opts.transformOutput=false] - use the parser's output as
 *                                                 the outgoing "data" forr this
 *                                                 stream.
 * @param {String} [opts.fileName] - filename to use for error messages.
 * @returns {stream.Transform}
 * @memberof api
 *
 * @example
 * var source = fs.createReadStream("/some/file.csv", {encoding: "utf8"});
 * var destination = fs.createWriteStream("/tmp/final-dest.txt");
 * var handle = parseStream(csvLine());
 * handle.on("parse", function(line) {
 *   console.log("Got a csv line with ", line.length, "columns.");
 * });
 * deepEqual(fs.readFileSync("/some/file.csv"),
 *           fs.readFileSync("/tmp/final-dest.txt"));
 * // => true
 */
function parseStream(parser, opts) {
  return new StreamParser(parser, {
    decodeStrings: false,
    encoding: "utf8",
    parseOpts: opts
  });
}

function StreamParser(parser, options) {
  if (!(this instanceof StreamParser)) {
    return new StreamParser(options);
  }
  Transform.call(this, options);
  this._transformOutput = (options.parseOpts &&
                           options.parseOpts.transformOutput);
  this._handle = mona.parseAsync(parser,
                                 this._onParse.bind(this),
                                 options.parseOpts);
}

StreamParser.prototype._transform = function(chunk, encoding, done) {
  if (typeof chunk !== "string") {
    done(new Error("parseStream only supports strings for now"));
  }
  try {
    this._handle.data(chunk);
    if (!this._transformOutput) {
      this.push(chunk);
    }
    done();
  } catch (e) {
    done(e);
  }
};

StreamParser.prototype._flush = function(done) {
  try {
    this._handle.done();
    done();
  } catch (e) {
    done(e);
  }
};

StreamParser.prototype._onParse = function(err, parsed) {
  if (err) { throw err; }
  this.emit("parse", parsed);
  if (this._transformOutput) {
    this.push(parsed);
  }
};

module.exports.parseStream = parseStream;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Namespaces</h3><ul><li><a href="api.html">api</a></li><li><a href="combinators.html">combinators</a></li><li><a href="core.html">core</a></li><li><a href="numbers.html">numbers</a></li><li><a href="strings.html">strings</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a> on Thu Sep 26 2013 00:18:05 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
